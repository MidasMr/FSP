# FSP Service

## Описание проекта

**FSP Service** — это веб-приложение на базе FastAPI, которое предоставляет пользователям возможность находить кратчайшее расстояние между городами. Приложение использует графовое представление городов и маршрутов между ними и реализует алгоритм Дейкстры для поиска кратчайшего пути.

## Функциональность

### Основные функции

- **Создание графов городов**: Создание, просмотр и обновление городов, а также соединений между ними.
- **Поиск кратчайшего пути**: Рассчитывает минимальное расстояние между двумя заданными городами.

### Пример API запроса

```
GET /cities/{city}/findShortestPath?to={targetCity}
```

### Пример ответа API

```json
{
    "city": "City Name",
    "result": {
        "distance": 100,
        "targetCity": "Target City Name"
    }
}
```

## Техническая реализация

### Архитектура

Проект выполнен с использованием **Vertical Slice Architecture**. Этот подход подразумевает разделение приложения на независимые вертикальные срезы, каждый из которых включает в себя все компоненты, необходимые для выполнения конкретной функциональности (маршрут, бизнес-логика, доступ к данным и т.д.). Такой подход делает приложение более поддерживаемым и расширяемым.

### Основные компоненты

- **Алгоритмы**: Реализация алгоритма Дейкстры находится в `app/algorithms/dijkstra.py`.
- **Модели базы данных**: Описаны в файле `app/db/models.py` и используются для представления городов и соединений между ними.
- **Маршруты API**: Находятся в `app/routers/`, обеспечивая связь между запросами пользователей и логикой приложения.
- **Утилиты**: В `app/utils/` содержатся функции для импорта данных из файла `sample.txt` в базу данных и другие вспомогательные функции.

### Работа с базой данных

- **Выбор базы данных**: Проект использует PostgreSQL благодаря его надежности и мощным возможностям для работы с графами и сложными запросами.
- **Организация данных**: Граф городов и маршрутов хранится в базе данных, структура данных соответствует нормальной форме (DKNF), что исключает избыточность и аномалии данных.
- **Миграции**: Для управления изменениями схемы базы данных используется Alembic. Это позволяет безопасно и контролируемо обновлять структуру базы данных.

### Обработка данных и работа с сессиями

- **SQLAlchemy**: Используется как ORM для работы с базой данных, что обеспечивает удобную и безопасную работу с данными.
- **Сессии**: Взаимодействие с сессиями базы данных осуществляется через DI (dependency injection) с использованием Starlette `app.state`, что позволяет управлять временем жизни сессий и обеспечивает чистоту кода.

## Установка и запуск

**Клонирование репозитория**:

   ```bash
   git clone https://github.com/MidasMr/FSP.git
   cd FSP
   ```

### С использованием Docker

1. **Сборка и запуск контейнеров**:

   ```bash
   docker-compose up --build
   ```

2. **Импорт данных**:

    ```bash
    docker exec fsp-app sh -c 'python -m app.utils.import_data'
    ```

3. **Доступ к приложению**: Откройте `http://localhost:8008` в браузере. Для просмотра доступных эндпоинтов и тестрования API приложения можно использовать `http://localhost:8008/docs` или `http://localhost:8008/redoc`

### Локальная установка

1. **Требования**: Убедитесь, что у вас установлены Python 3.11+ и PostgreSQL.

2. **Создайте базу данных в PostgreSQL**

3. **Установка зависимостей**:

   ```bash
   pip install -r requirements.txt
   ```

4. **Создание базы данных и применение миграций**:

   ```bash
   alembic upgrade head
   ```

5. **Импорт данных**:

    ```bash
    python -m app.utils.import_data
    ```

6. **Запуск приложения**:

   ```bash
   uvicorn app.main:app --reload
   ```

### Запуск тестов

```bash
pytest
```

### Решение задачи и принятые решения

#### 1. **Выбор архитектуры проекта**

Для данного проекта была выбрана **Vertical Slice Architecture**. Этот подход разделяет приложение на независимые функциональные модули, каждый из которых отвечает за определенную часть логики. Преимущества данного подхода включают:

- **Изоляция кода**: Каждая функциональная часть приложения отделена от других, что упрощает поддержку и развитие проекта.
- **Масштабируемость**: Вертикальные срезы легко добавлять и изменять, что позволяет быстро адаптировать проект к новым требованиям.

#### 2. **Обработка графа городов**

##### Хранение данных

Граф городов был выбран в качестве основного представления данных. Для его хранения использовалась база данных PostgreSQL. Для представления графа были созданы две основные таблицы:

- **Таблица "Города" (Cities)**: Содержит информацию о городах.
- **Таблица "Связи" (Connections)**: Содержит информацию о прямых маршрутах между городами и расстояниях между ними.

#### 3. **Алгоритм поиска кратчайшего пути**

Для поиска кратчайшего пути между двумя городами был выбран **алгоритм Дейкстры**. Этот алгоритм наиболее подходящий для данной задачи, поскольку:

- **Оптимальность для неотрицательных весов**: Алгоритм Дейкстры работает быстро и эффективно, когда все веса (расстояния) в графе неотрицательны, что идеально подходит для задачи поиска кратчайшего пути между городами.
- **Производительность**: Алгоритм использует приоритетные очереди для обработки узлов графа, что обеспечивает хорошую производительность даже на больших графах.

Реализация алгоритма была выполнена в модуле `app/algorithms/dijkstra.py`, где он использует данные, загруженные из базы данных, для вычисления кратчайшего пути.

#### 4. **Импорт и обработка данных**

Для загрузки данных о городах и маршрутах из файла `sample.txt` был реализован скрипт `app/utils/import_data.py`. Этот скрипт:

- Читает файл `sample.txt` и парсит данные.
- Вставляет данные в таблицы базы данных с помощью SQLAlchemy.

#### 5. **Работа с сессиями базы данных**

Для управления сессиями базы данных используется подход через DI (dependency injection) с использованием Starlette `app.state`. Этот подход позволяет:

- **Контролировать время жизни сессий**: Сессии базы данных автоматически создаются и закрываются в начале и в конце каждого запроса, что помогает избежать утечек ресурсов.
- **Поддерживать чистоту кода**: Использование DI обеспечивает более чистую и управляемую архитектуру, где зависимости явно указываются и контролируются.

## Дополнительная информация

### Файл SQL-запроса

Файл `closest_cities_diff.sql` содержит SQL-запрос, который позволяет вычислить разницу расстояний между ближайшими по алфавиту целевыми городами для прямых маршрутов из указанного города.

## Стэк технологий

### Backend

- **Python 3.9+**
- **FastAPI**
- **SQLAlchemy**
- **Alembic**
- **Pydantic**

### База данных

- **PostgreSQL**

### Контейнеризация

- **Docker**
- **Docker Compose**

### Тестирование

- **pytest**
- **FastAPI TestClient**

### Инструменты разработки

- **Git**